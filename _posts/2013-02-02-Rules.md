---
layout: post
title: Rules
tags: FireWall
categories: ğŸŒ-NET
---




### è§„åˆ™(Rules)
- RulesåŒ…æ‹¬ä¸€ä¸ªæ¡ä»¶å’Œä¸€ä¸ªç›®æ ‡(target)
- å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œå°±æ‰§è¡Œç›®æ ‡(target)ä¸­çš„è§„åˆ™æˆ–è€…ç‰¹å®šå€¼ã€‚
- å¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œå°±åˆ¤æ–­ä¸‹ä¸€æ¡Rulesã€‚

#### ç›®æ ‡å€¼ï¼ˆTarget Valuesï¼‰
- *ACCEPT* â€“  é˜²ç«å¢™æ¥æ”¶æ•°æ®åŒ…
- *DROP*   â€“  é˜²ç«å¢™ä¸¢å¼ƒåŒ…
- QUEUE â€“  é˜²ç«å¢™å°†æ•°æ®åŒ…ç§»äº¤åˆ°ç”¨æˆ·ç©ºé—´
- RETURN â€“ é˜²ç«å¢™åœæ­¢æ‰§è¡Œå½“å‰é“¾ä¸­çš„åç»­Rulesï¼Œå¹¶è¿”å›åˆ°è°ƒç”¨é“¾(the calling chain)ä¸­ã€‚


è§„åˆ™è§£é‡Š:

|é€‰é¡¹|è§£é‡Š|
|:---:|:---:|
| num | è§„åˆ™ç¼–å· |
| target | ç›®æ ‡å€¼ |
| prot | åè®®: tcp udp icmp ç­‰ |
| source | æ•°æ®åŒ…æº IP åœ°å€ |
| destination | æ•°æ®åŒ…ç›®æ ‡ IP åœ°å€ |



å¸¸ç”¨å‘½ä»¤:

- æ¸…ç©º iptables è§„åˆ™:
	 
		iptables -F
		æœ‰äº› linux ç‰ˆæœ¬ ç”¨è¿™ä¸ªå‘½ä»¤ ä¸ä¼šæ¸…é™¤ NAT è¡¨é‡Œé¢çš„è§„åˆ™
		éœ€è¦æ‰‹åŠ¨æ¸…é™¤:
		iptables -t NAT -F

 
 
### è§„åˆ™æ°¸ä¹…ç”Ÿæ•ˆ
ç³»ç»Ÿé‡å¯å è§„åˆ™ä¼šå¤±æ•ˆ. è¦æ°¸ä¹…æœ‰æ•ˆ:ä¸åŒç³»ç»Ÿä¸åŒæ“ä½œ  
 
##### Debian / Ubuntu  

 - ä¿å­˜ç°æœ‰è§„åˆ™
		iptables-save > /etc/iptables.rules

- åˆ°/etc/network/if-pre-up.d/ç›®å½•  
- æ–°å»ºä¸€ä¸ª bash è„šæœ¬  (æ–°å»ºæ–‡ä»¶å°±è¡Œ å†…å®¹ç”¨#!/bin/bashå¼€å¤´ å°±æ˜¯è„šæœ¬æ–‡ä»¶.)
- è„šæœ¬å†…å®¹å¦‚ä¸‹(ä¸¤è¡Œ)
	 
		#!/bin/bash
		iptables-restore < /etc/iptables.rules
		
		è¿™æ · æ¯æ¬¡ç³»ç»Ÿé‡å¯å iptables è§„åˆ™ä¼šè¢«è‡ªåŠ¨åŠ è½½.


åŸºæœ¬æ“ä½œ

|åŠŸèƒ½|å‘½ä»¤|  
|:---:|:---:|
| å¯åŠ¨ iptables | service iptables start |
| å¯åŠ¨iptables | /etc/rc.d/init.d/iptables start |
| å…³é—­ iptables | service iptables stop |
| å…³é—­iptables | /etc/rc.d/init.d/iptables stop |
| é‡å¯ iptables | service iptables restart |
| æŸ¥çœ‹ iptablesçŠ¶æ€ | service iptables status |
| ä¿å­˜ iptablesé…ç½® | service iptables save |

|åŠŸèƒ½|å‘½ä»¤|
|:---:|:---:|
| Iptables æœåŠ¡é…ç½®æ–‡ä»¶ | /etc/sysconfig/iptables-config |
| Iptables è§„åˆ™ä¿å­˜æ–‡ä»¶ | /etc/sysconfig/iptables |




å‘½ä»¤:
 
	    iptables [ -t è¡¨å] å‘½ä»¤é€‰é¡¹ [é“¾å] [æ¡ä»¶åŒ¹é…] [-j ç›®æ ‡åŠ¨ä½œæˆ–è€…è·³è½¬]

å¸¸ç”¨å‘½ä»¤:

é˜»æ­¢ IP åœ°å€ä¸º 10.10.10.10 çš„æ‰€æœ‰è¿æ¥ã€‚  
     
	    iptables -A INPUT -s 10.10.10.10 -j DROP

é˜»æ­¢ä¸€ç»„ ip çš„æ‰€æœ‰è¿æ¥  (å¯ä»¥ç”¨ å­ç½‘æ©ç  æˆ–è€… /æ¥è¡¨ç¤ºä¸€ä¸ªå­ç½‘)
 
	    iptables -A INPUT -s 10.10.10.0/24 -j DROP

é˜»æ­¢ç‰¹å®š ip çš„ ssh è¿æ¥.  
     
	    iptables -A INPUT -p tcp --dport ssh -s 10.10.10.10 -j DROP
	    ssh å¯ä»¥æ¢æˆåˆ«çš„åè®®  
	    -p tcp æ˜¯å‘Šè¯‰ iptables è¿æ¥ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆåè®®.

é˜»æ­¢æ‰€æœ‰ ip çš„ ssh è¿æ¥
 
	    iptables -A INPUT -p tcp â€”dport ssh -j DROP


æŸ¥çœ‹iptablesè§„åˆ™ 
 
	    iptables â€“Lï¼ˆiptables â€“L â€“v -nï¼‰ 

åˆ é™¤iptablesç°æœ‰è§„åˆ™

	    iptables â€“F 
åˆ é™¤ä¸€æ¡è§„åˆ™
 
	    iptabels -D INPUT 2 

ä¿®æ”¹ä¸€æ¡è§„åˆ™
 
	    iptables -R INPUT 3 -i eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT 

å…è®¸è¿œç¨‹ä¸»æœºè¿›è¡ŒSSHè¿æ¥
 
	    iptables -A INPUT -i eth0 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT 
	    iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT 

å…è®¸æœ¬åœ°ä¸»æœºè¿›è¡ŒSSHè¿æ¥  
     
	    iptables -A OUTPUT -o eth0 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT   
	    iptables -A INTPUT -i eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT 

å…è®¸HTTPè¯·æ±‚  
     
	    iptables -A INPUT -i eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT 
	    iptables -A OUTPUT -o eth0 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT 



é™åˆ¶ping 192.168.146.3ä¸»æœºçš„æ•°æ®åŒ…æ•°ï¼Œå¹³å‡2/sä¸ªï¼Œæœ€å¤šä¸èƒ½è¶…è¿‡3ä¸ª  

	    iptables -A INPUT -i eth0 -d 192.168.146.3 -p icmp --icmp-type 8 -m limit --limit 2/second --limit-burst 3 -j ACCEPT 

é™åˆ¶SSHè¿æ¥é€Ÿç‡(é»˜è®¤ç­–ç•¥æ˜¯DROP)

	    iptables -I INPUT 1 -p tcp --dport 22 -d 192.168.146.3 -m state --state ESTABLISHED -j ACCEPT  
	    iptables -I INPUT 2 -p tcp --dport 22 -d 192.168.146.3 -m limit --limit 2/minute --limit-burst 2 -m state --state NEW -j ACCEPT 

å¢åŠ ä¸€æ¡è§„åˆ™åˆ°æœ€å

	    iptables -A INPUT -i eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT 



### å®‰å…¨è®¾ç½®:
#### é˜²æ­¢synæ”»å‡»
 æ€è·¯ï¼šé™åˆ¶å•ä¸ªipçš„æœ€å¤§synè¿æ¥æ•°  
         
	    iptables â€“A INPUT â€“i eth0 â€“p tcp --syn -m connlimit --connlimit-above 15 -j DROP 


#### é˜²æ­¢DOSæ”»å‡»
åˆ©ç”¨recentæ¨¡å—æŠµå¾¡DOSæ”»å‡»  
     
	    iptables -I INPUT -p tcp -dport 22 -m connlimit --connlimit-above 3 -j DROP 

å•ä¸ªIPæœ€å¤šè¿æ¥3ä¸ªä¼šè¯
 
	    iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --set --name SSH  



åªè¦æ˜¯æ–°çš„è¿æ¥è¯·æ±‚ï¼Œå°±æŠŠå®ƒåŠ å…¥åˆ°SSHåˆ—è¡¨ä¸­
 
	    Iptables -I INPUT -p tcp --dport 22 -m state NEW -m recent --update --seconds 300 --hitcount 3 --name SSH -j DROP  

5åˆ†é’Ÿå†…ä½ çš„å°è¯•æ¬¡æ•°è¾¾åˆ°3æ¬¡ï¼Œå°±æ‹’ç»æä¾›SSHåˆ—è¡¨ä¸­çš„è¿™ä¸ªIPæœåŠ¡ã€‚è¢«é™åˆ¶5åˆ†é’Ÿåå³å¯æ¢å¤è®¿é—®ã€‚


é˜²æ­¢å•ä¸ªipè®¿é—®é‡è¿‡å¤§  
     
	    iptables -I INPUT -p tcp --dport 80 -m connlimit --connlimit-above 30 -j DROP 

é˜²æ­¢pingæ”»å‡»  
     
	    iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/m -j ACCEPT 


åŸºæœ¬æ“ä½œ

|é€‰é¡¹|åŠŸèƒ½|  
|:---|:---:|  
| -A (append) | æŒ‡å®šé“¾æœ«å°¾ æ·»åŠ è§„åˆ™ | 
| -D (delete) | åˆ é™¤ä¸€æ¡è§„åˆ™ |  
| -I (insert) | æŒ‡å®šé“¾å¼€å¤´ æ·»åŠ è§„åˆ™ |  
| -R (replace) | æ›¿æ¢è§„åˆ™ |
| -L (list) | åˆ—å‡ºæ‰€æœ‰è§„åˆ™ |
| -F (flush) | æ¸…ç©ºæ‰€æœ‰è§„åˆ™ |
| -N (new chain) | æ–°å»ºè‡ªå®šä¹‰è§„åˆ™ |
| -P (policy) | è®¾ç½®æŒ‡å®šé“¾çš„é»˜è®¤ç­–ç•¥ |
| -v (verbose) | æŸ¥çœ‹è§„åˆ™åˆ—è¡¨æ—¶ æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ |
| -V (Version) | æŸ¥çœ‹ iptables ç‰ˆæœ¬è¯¦ç»† |





æ‰“å¼€iptablesè½¬å‘ï¼šecho "1"\> /proc/sys/net/ipv4/ip\_forward




iptables -L -v  
æŸ¥çœ‹ è¾“å…¥è¾“å‡ºè½¬å‘çš„ æ•°æ®é‡.   å¦‚æœè½¬å‘é‡æ˜¯ 0 å°±è¯´æ˜æ²¡æœ‰å¼€å¯è½¬å‘.

æ³¨æ„: å¾ˆå¤šæ—¶å€™éƒ½æ˜¯ è¾“å…¥è¾“å‡º åŒå‘é€šä¿¡çš„.   ä¸€èˆ¬éƒ½éœ€è¦åŒæ—¶é…ç½®è¾“å…¥å’Œè¾“å‡º é˜²ç«å¢™.  æ¯”å¦‚ ssh / ping


é»˜è®¤è¡Œä¸º:æ²¡æœ‰è®¾ç½®è§„åˆ™æ—¶å€™ åšå‡ºçš„è¡Œä¸º. 
iptables -L    æŸ¥çœ‹å½“å‰ iptables çš„é…ç½®.
-v æ˜¾ç¤ºæ•°æ®åŒ…å’Œå­—èŠ‚ä¿¡æ¯,
-n ä¸å°† ip è§£ææˆåŸŸå.


policy Accept   å…è®¸è¿æ¥.
policy Drop     ä¸¢å¼ƒæ•°æ®åŒ…
policy Reject   ä¸å…è®¸è¿æ¥å¹¶è¿”å›ä¸€ä¸ªä¿¡æ¯. ä¸æƒ³è®©æŸä¸ª ip è¿œç¨‹ä½  è¿”å›ä¿¡æ¯é˜²ç«å¢™é˜»æ­¢ä½ ç™»é™†.


iptables -A    å°†é¢å¤–çš„è§„åˆ™ æ·»åŠ åˆ°ç°æœ‰è§„åˆ™.




- Ubuntu é»˜è®¤å…³é—­é˜²ç«å¢™. 
	Uncomplicated Fire Wall(UFW):  iptable çš„ç®¡ç†å·¥å…·(ä½¿ç”¨ç®€å•).
	å®‰è£… UFW :    sudo apt-get install ufw 
	å¯ç”¨é˜²ç«å¢™:ã€€ã€€sudo ufw enable 




/etc/sysconfig/iptables


iptablesï¼šåº”ç”¨é˜²ç«å¢™è§„åˆ™ï¼šiptables-restore: line 17 failed

/etc/init.d/iptables stopå…³é—­
/etc/init.d/iptables startå¯åŠ¨
/etc/init.d/iptables restarté‡å¯








